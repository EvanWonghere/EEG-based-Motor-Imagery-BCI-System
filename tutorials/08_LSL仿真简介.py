# -*- coding: utf-8 -*-
"""
教程 08：LSL 仿真简介
=====================
目标：理解 LSL 是什么、在本项目中“发送端/接收端”各做什么，以及如何用 Python 发送预测结果。
"""

# ---------------------------------------------------------------------------
# 一、LSL 是什么？
# ---------------------------------------------------------------------------
# Lab Streaming Layer (LSL) 是一种**跨平台、跨语言的网络协议**，用来在局域网内
# “流式”传输数据（如 EEG 采样点、事件标记、控制指令等）。
#
# 概念：
#   - 发送端 (Outlet)：创建一条“流”，往里 push 数据（如每秒发一个字符串 "Left" / "Right"）。
#   - 接收端 (Inlet)：按“流名称”或类型搜索，连上后不断 pull 数据。
# 这样，Python 训练好的模型“预测出一个指令”后，通过 LSL 推出去，Unity 端用 LSL 接收，
# 就能根据指令驱动虚拟场景（如“左手想象 → 物体向左移动”），实现**无真实 EEG 硬件**的仿真。

# ---------------------------------------------------------------------------
# 二、本项目的角色分工
# ---------------------------------------------------------------------------
# - Python（发送端）：运行 replay_stream.py，从已保存的模型和试次里不断取一段数据 → 预测 → 把 "Left"/"Right" 等通过 LSL 发出去。
# - Unity（接收端）：运行场景，用 LSL4Unity 或 LSL.cs 搜索名为 "BCI_Control" 的流，在 Update() 里 pull 样本，根据收到的字符串执行逻辑。
#
# 因为数据是“回放”的，所以叫“仿真”；没有真实脑电帽也能验证整条链路。

# ---------------------------------------------------------------------------
# 三、用 pylsl 发送字符串标记（最小示例）
# ---------------------------------------------------------------------------
# 下面代码：创建一个名为 BCI_Control 的流，每隔 2 秒发一个随机的 "Left" 或 "Right"。
# 你可以先运行本脚本，再在另一个终端或 Unity 里用接收端连接，验证能收到数据。
# 按 Ctrl+C 停止发送。

import time
import random
from pylsl import StreamInfo, StreamOutlet

# 定义流：名称、类型、通道数、采样率、数据格式
# nominal_srate=0 表示“不规则采样”，按需 push 即可
info = StreamInfo(
    name="BCI_Control",
    type="Markers",
    channel_count=1,
    nominal_srate=0,
    channel_format="string",
    source_id="tutorial_08_demo",
)
outlet = StreamOutlet(info)

print("LSL 发送端已启动，流名称: BCI_Control")
print("每隔 2 秒发送一个随机指令 (Left/Right)，按 Ctrl+C 停止。\n")

try:
    while True:
        cmd = random.choice(["Left", "Right"])
        outlet.push_sample([cmd])
        print("  发送:", cmd)
        time.sleep(2.0)
except KeyboardInterrupt:
    print("\n已停止。")

# ---------------------------------------------------------------------------
# 四、与 replay_stream.py 的关系
# ---------------------------------------------------------------------------
# replay_stream.py 做的是：不是随机发，而是从 models/replay_data.npz 里取真实试次
# → 用已训练好的 CSP+LDA 模型预测 → 把预测结果（如 "Left"/"Right"）通过 LSL 发出去。
# 这样 Unity 端收到的就是“模型认为的想象类型”，实现闭环仿真。
# ---------------------------------------------------------------------------
print("\n【小结】LSL 负责 Python ↔ Unity 的通信；本项目用“回放+预测”模拟实时 BCI。")
print("教程 08 结束。你已学完从信号处理到 LSL 的完整流程。")
